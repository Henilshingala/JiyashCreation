{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes"/>
<title>{% block title %}Jiyash Creation{% endblock %}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary-color: #2d5a3d;
    --primary-light: #6fbf8f;
    --primary-bg: #ffffff;
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    font-size: 16px;
    scroll-behavior: smooth;
  }
body {
  font-family: 'Inter', sans-serif;
  line-height: 1.6;
  color: #1f3f2b;
  background-color: var(--primary-bg);
  overflow-x: hidden;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 15px;
}
.header-container {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: white;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.header-container.scrolled {
  box-shadow: 0 4px 25px rgba(0,0,0,0.12);
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(8px, 3vw, 20px) 0;
  position: relative;
  min-height: 60px;
}
.header h1 {
  font-family: 'Dancing Script', cursive;
  font-size: clamp(20px, 5vw, 42px);
  font-weight: 700;
  color: #2d5a3d;
  text-shadow: 0 2px 4px rgba(45, 90, 61, 0.1);
  letter-spacing: 0.5px;
  flex-shrink: 0;
}
.header-nav {
  display: none;
  align-items: center;
  gap: clamp(15px, 4vw, 35px);
  flex: 1;
  justify-content: center;
  margin: 0 clamp(20px, 5vw, 40px);
}
.header-nav ul {
  list-style: none;
  display: flex;
  align-items: center;
  gap: clamp(15px, 4vw, 35px);
  margin: 0;
  padding: 0;
}
.header-nav li {
  position: relative;
}
.header-nav > ul > li > a {
  display: block;
  padding: clamp(5px, 2vw, 10px) clamp(5px, 2vw, 8px);
  text-decoration: none;
  color: #1f3f2b;
  font-weight: 500;
  font-size: clamp(13px, 3.5vw, 15px);
  transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;
}
.header-nav a:hover {
  color: var(--primary-color);
}
.header-nav > ul > li > a::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 2px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  transition: width 0.3s ease;
} 
.header-nav > ul > li:hover > a::after {
  width: 100%;
}
.header-nav .mega {
  position: absolute;
  top: calc(100% + 15px);
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 12px;
  box-shadow: 0 15px 50px rgba(0,0,0,0.15);
  padding: clamp(20px, 5vw, 30px);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  min-width: clamp(300px, 80vw, 800px);
  max-width: 95vw;
  border: 1px solid rgba(45, 90, 61, 0.1);
}
.header-nav li:hover .mega {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(0);
}
.wrap {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 25vw, 180px), 1fr));
  gap: clamp(15px, 5vw, 30px);
  width: 100%;
}
.col h4 {
  margin-bottom: clamp(10px, 3vw, 15px);
  color: var(--primary-color);
  font-size: clamp(14px, 3.5vw, 16px);
  font-weight: 600;
  border-bottom: 2px solid rgba(45, 90, 61, 0.1);
  padding-bottom: 8px;
}
.col h4 a {
  color: var(--primary-color);
  padding: 0;
  text-decoration: none;
}
.col a {
  display: block;
  padding: clamp(6px, 2vw, 8px) 0;
  color: #666;
  text-decoration: none;
  font-size: clamp(12px, 3vw, 14px);
  font-weight: 400;
  transition: all 0.3s ease;
  line-height: 1.4;
}
.col a:hover {
  color: var(--primary-color);
  padding-left: 8px;
}
.right-icons {
  display: flex;
  align-items: center;
  gap: clamp(8px, 3vw, 20px);
  flex-shrink: 0;
}
.user-profile-dropdown {
  position: relative;
}
.icon {
  font-size: clamp(16px, 4vw, 20px);
  color: var(--primary-color);
  cursor: pointer;
  padding: clamp(6px, 2vw, 10px);
  border-radius: 50%;
  transition: all 0.3s ease;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 44px;
  min-height: 44px;
}
.icon:hover {
  background: rgba(45, 90, 61, 0.1);
  transform: translateY(-1px);
}
.fa-bag-shopping {
  position: relative;
}
.cart-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: clamp(16px, 4vw, 20px);
  height: clamp(16px, 4vw, 20px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(9px, 2.5vw, 12px);
  font-weight: 600;
  border: 2px solid white;
}
.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  background: white;
  min-width: 180px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  border: 1px solid rgba(45, 90, 61, 0.1);
  z-index: 1001;
  display: block !important;
}
.user-dropdown-menu.active {
  opacity: 1 !important;
  visibility: visible !important;
  transform: translateY(0) !important;
}
.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: clamp(10px, 3vw, 15px) clamp(15px, 4vw, 20px);
  color: #1f3f2b;
  text-decoration: none;
  font-weight: 500;
  font-size: clamp(13px, 3.5vw, 15px);
  transition: all 0.3s ease;
  white-space: nowrap;
}
.dropdown-item:hover {
  background: rgba(45, 90, 61, 0.05);
  color: var(--primary-color);
}
.dropdown-item i {
  width: 16px;
  color: var(--primary-color);
  flex-shrink: 0;
}
.mobile-menu-toggle {
  display: none;
  flex-direction: column;
  cursor: pointer;
  padding: 12px;
  gap: 5px;
  min-width: 50px;
  min-height: 50px;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.3s ease;
  background: #2d5a3d;
  border: 2px solid #1f3f2b;
  outline: none;
  position: relative;
  z-index: 1000;
}
.mobile-menu-toggle:hover {
  background: #1f3f2b;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.mobile-menu-toggle span {
  display: block;
  width: 24px;
  height: 3px;
  background-color: #ffffff;
  transition: all 0.3s ease;
  transform-origin: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.2);
}
.mobile-menu-toggle.active span:nth-child(1) {
  transform: rotate(45deg) translate(6px, 6px);
}
.mobile-menu-toggle.active span:nth-child(2) {
  opacity: 0;
  transform: scaleX(0);
}
.mobile-menu-toggle.active span:nth-child(3) {
  transform: rotate(-45deg) translate(6px, -6px);
}
nav {
  background: #f8f9fa;
  border-top: 1px solid rgba(45, 90, 61, 0.1);
  position: relative;
  transition: all 0.3s ease;
}
nav.scrolled {
  background: rgba(248, 249, 250, 0.95);
  backdrop-filter: blur(10px);
}
.nav-inner {
  padding: 0;
}
.nav-inner ul {
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: clamp(15px, 4vw, 40px);
  padding: 0;
  flex-wrap: wrap;
}
.nav-inner li {
  position: relative;
}
.nav-inner > ul > li > a {
  display: block;
  padding: clamp(12px, 3vw, 20px) clamp(5px, 2vw, 10px);
  text-decoration: none;
  color: #1f3f2b;
  font-weight: 500;
  font-size: clamp(13px, 3.5vw, 15px);
  transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;
}
.nav-inner a:hover {
  color: var(--primary-color);
}
.nav-inner > ul > li > a::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 3px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  transition: width 0.3s ease;
}
.nav-inner > ul > li:hover > a::after {
  width: 100%;
}
.mega {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 12px;
  box-shadow: 0 15px 50px rgba(0,0,0,0.15);
  padding: clamp(20px, 5vw, 30px);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  min-width: clamp(300px, 80vw, 800px);
  max-width: 95vw;
  border: 1px solid rgba(45, 90, 61, 0.1);
}
.nav-inner li:hover .mega {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(0);
}
main {
  min-height: 70vh;
  padding: clamp(20px, 5vw, 40px) 0;
}
footer {
  background: #2d5a3d;
  color: white;
  text-align: center;
  padding: clamp(20px, 5vw, 30px);
  font-size: clamp(12px, 3vw, 14px);
}
@media (min-width: 1024px) {
  .header-nav {
    display: flex !important;
  }
  nav {
    display: none;
  }
}
@media (max-width: 1023px) {
  .mobile-menu-toggle {
    display: flex !important;
  }
  .header-nav {
    display: none !important;
  }
  nav {
    position: fixed;
    top: 0;
    left: -100%;
    width: 100vw;
    height: 100vh;
    background: white;
    z-index: 2000;
    transition: left 0.3s ease;
    overflow-y: auto;
  }
  nav.show {
    left: 0;
  }
  .mobile-nav-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  .mobile-back-btn {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--primary-color);
    cursor: pointer;
    padding: 8px;
    margin-right: 15px;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
  }
  .mobile-back-btn:hover {
    background: rgba(45, 90, 61, 0.1);
  }
  .mobile-nav-title {
    font-family: 'Dancing Script', cursive;
    font-size: 24px;
    font-weight: 700;
    color: #2d5a3d;
    margin: 0;
    padding: 0 15px;
    text-align: center;
    flex-grow: 1;
  }
  .mobile-close-btn {
    margin-left: auto;
    background: none;
    border: none;
    font-size: 20px;
    color: #666;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .mobile-close-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }
  .mobile-menu-level {
    display: none;
    padding: 0;
  }
  .mobile-menu-level.active {
    display: block;
  }
  .mobile-menu-level ul {
    flex-direction: column;
    padding: 0;
    gap: 0;
    align-items: stretch;
    justify-content: flex-start;
    list-style: none;
  }
  .mobile-menu-level li {
    margin: 0;
    border-bottom: 1px solid #eee;
    width: 100%;
  }
  .mobile-menu-level a,
  .mobile-menu-level button {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    font-size: 16px;
    color: #1f3f2b;
    text-decoration: none;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }
  .mobile-menu-level a:hover,
  .mobile-menu-level button:hover {
    background: rgba(45, 90, 61, 0.05);
  }
  .mobile-menu-level .arrow-right {
    color: #666;
    font-size: 14px;
  }
  .mega {
    display: none !important;
  }
  .nav-inner ul {
    display: none;
  }
  body.menu-open::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1500;
    opacity: 0;
    animation: fadeIn 0.3s ease forwards;
  }
  @keyframes fadeIn {
    to { opacity: 1; }
  }
}
@media (min-width: 768px) and (max-width: 1023px) {
  .container {
    padding: 0 20px;
  }
  .nav-inner ul {
    gap: 20px;
    justify-content: space-around;
  }
  .mega {
    min-width: 500px;
    padding: 20px;
  }
  .wrap {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
}
@media (min-width: 769px) {
  .mobile-nav-header {
    display: none !important;
  }
  .mobile-menu-level {
    display: none !important;
  }
  .desktop-only {
    display: block !important;
  }
  .nav-inner ul {
    gap: 35px;
    display: flex !important;
  }
  .mega {
    min-width: 700px;
  }
}
@media (min-width: 1024px) and (max-width: 1280px) {
  .header { padding: 10px 0; gap: 10px; }
  .header h1 { font-size: clamp(20px, 3.5vw, 34px); }
  .header-nav { gap: 18px; margin: 0 16px; }
  .header-nav ul { gap: 18px; }
  .header-nav > ul > li > a { font-size: 14px; padding: 6px 6px; }
  .right-icons { gap: 10px; }
  .icon { min-width: 40px; min-height: 40px; font-size: 18px; }
}
.hidden-by-auth { display: none !important; }
</style>
</head>
<body>

<div class="header-container" id="header-container">
  <div class="container">
    <header class="header" id="header">
      <h1><a href="{% url 'app:home' %}" style="text-decoration: none; color: inherit;">Jiyash Creation</a></h1>
      
      <div class="header-nav">
        <ul>
          <li><a href="{% url 'app:home' %}">Home</a></li>
          <li>
            <a href="#" role="button" aria-expanded="false">Collection</a>
            {% if header_categories %}
            <div class="mega" style="min-width:clamp(280px, 70vw, 350px)" role="menu" aria-hidden="true">
              <div class="wrap">
                <div class="col">
                  {% for c in header_categories %}
                    <a href="{% url 'app:collection' collection_type=c.type %}" role="menuitem">{{ c.name }}</a>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endif %}
          </li>
          <li><a href="{% url 'app:shop_all' %}">Shop All</a></li>
          <li><a href="{% url 'app:faqs' %}">FAQs</a></li>
          <li>
            <a href="#" role="button" aria-expanded="false">About Us</a>
            <div class="mega" style="min-width:clamp(280px, 70vw, 350px)" role="menu" aria-hidden="true">
              <div class="wrap">
                <div class="col">
                  <a href="{% url 'app:about' %}" role="menuitem">Our Story</a>
                  <a href="{% url 'app:contact' %}" role="menuitem">Contact</a>
                  <a href="{% url 'app:faqs' %}" role="menuitem">FAQs</a>
                  <a href="{% url 'app:privacy_policies' %}" role="menuitem">Privacy Policies</a>
                  <a href="{% url 'app:terms_and_conditions' %}" role="menuitem">Terms & Conditions</a>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
      
      <div class="right-icons">
        <div class="user-profile-dropdown">
          <i class="fa-regular fa-user icon" title="Profile" id="userProfileIcon" role="button" tabindex="0" aria-label="User profile menu"></i>
          <div class="user-dropdown-menu" id="userDropdownMenu" role="menu">
            <div class="guest-group" data-auth="guest">
              <a href="{% url 'app:signup' %}" class="dropdown-item"><i class="fa-solid fa-user-plus"></i>Sign Up</a>
              <a href="{% url 'app:login' %}" class="dropdown-item"><i class="fa-solid fa-sign-in-alt"></i>Sign In</a>
            </div>
            <div class="auth-group" data-auth="auth">
              <a href="{% url 'app:profile' %}" class="dropdown-item profile-item"><i class="fa-regular fa-user"></i>Profile</a>
              <a href="{% url 'app:forgot_password' %}" class="dropdown-item"><i class="fa-solid fa-key"></i>Forgot Password</a>
              <a href="#" id="logoutBtn" class="dropdown-item"><i class="fa-solid fa-right-from-bracket"></i>Logout</a>
            </div>
          </div>
        </div>
        <a href="{% url 'app:wishlist' %}" class="icon" title="Wishlist" aria-label="Wishlist">
          <i class="fa-regular fa-heart"></i>
        </a>
        <a href="#" onclick="goToCart(event)" class="icon cart-icon" title="Shopping Cart" aria-label="Shopping cart">
          <i class="fa-solid fa-bag-shopping"></i>
          <span id="cartCount">0</span>
        </a>
        <button class="mobile-menu-toggle" id="mobileMenuToggle" role="button" tabindex="0" aria-label="Toggle mobile menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </header>
  </div>
</div>

<nav role="navigation" id="mobileNav">
  <div class="container">
    <div class="mobile-nav-header">
      <button class="mobile-back-btn" id="mobileBackBtn">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="mobile-nav-title" id="mobileNavTitle" style="font-family: 'Dancing Script', cursive; font-size: 24px; font-weight: 700; color: #2d5a3d; margin: 0; padding: 0 15px; text-align: center; flex-grow: 1;">Jiyash Creation</h1>
      <button class="mobile-close-btn" id="mobileCloseBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="mobile-menu-level active" id="mainMenuLevel">
      <ul>
        <li><a href="{% url 'app:home' %}">Home</a></li>
        {% if header_categories %}
          <li>
            <button class="collection-btn" data-target="collectionLevel">
              Collection
              <i class="fas fa-chevron-right arrow-right"></i>
            </button>
          </li>
        {% endif %}
        <li><a href="{% url 'app:shop_all' %}">Shop All</a></li>
        <li><a href="{% url 'app:faqs' %}">FAQs</a></li>
        <li>
          <button class="about-btn" data-target="aboutLevel">
            About Us
            <i class="fas fa-chevron-right arrow-right"></i>
          </button>
        </li>
        <li class="mobile-guest" data-auth="guest"><a href="{% url 'app:login' %}">Sign In</a></li>
        <li class="mobile-guest" data-auth="guest"><a href="{% url 'app:signup' %}">Sign Up</a></li>
        <li class="mobile-auth" data-auth="auth"><a href="{% url 'app:profile' %}">Profile</a></li>
        <li class="mobile-auth" data-auth="auth"><a href="{% url 'app:forgot_password' %}">Forgot Password</a></li>
        <li class="mobile-auth" data-auth="auth"><a href="#" id="mobileLogout">Logout</a></li>
      </ul>
    </div>
    <div class="mobile-menu-level" id="collectionLevel">
      {% if header_categories %}
      <ul>
        {% for c in header_categories %}
          <li><a href="{% url 'app:collection' collection_type=c.type %}">{{ c.name }}</a></li>
        {% endfor %}
      </ul>
      {% else %}
      <ul></ul>
      {% endif %}
    </div>
    <div class="mobile-menu-level" id="aboutLevel">
      <ul>
        <li><a href="{% url 'app:about' %}">Our Story</a></li>
        <li><a href="{% url 'app:contact' %}">Contact</a></li>
        <li><a href="{% url 'app:faqs' %}">FAQs</a></li>
        <li><a href="{% url 'app:privacy_policies' %}">Privacy Policies</a></li>
        <li><a href="{% url 'app:terms_and_conditions' %}">Terms & Conditions</a></li>
      </ul>
    </div>
    <div class="nav-inner desktop-only" id="navInner">
      <ul>
        <li><a href="{% url 'app:home' %}">Home</a></li>
        <li>
          <a href="#" role="button" aria-expanded="false">Collection</a>
          {% if header_categories %}
          <div class="mega" style="min-width:clamp(280px, 70vw, 350px)" role="menu" aria-hidden="true">
            <div class="wrap">
              <div class="col">
                {% for c in header_categories %}
                  <a href="{% url 'app:collection' collection_type=c.type %}" role="menuitem">{{ c.name }}</a>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
        </li>
        <li><a href="{% url 'app:shop_all' %}">Shop All</a></li>
        <li><a href="{% url 'app:faqs' %}">FAQs</a></li>
        <li>
          <a href="#" role="button" aria-expanded="false">About Us</a>
          <div class="mega" style="min-width:clamp(280px, 70vw, 350px)" role="menu" aria-hidden="true">
            <div class="wrap">
              <div class="col">
                <a href="{% url 'app:about' %}" role="menuitem">Our Story</a>
                <a href="{% url 'app:contact' %}" role="menuitem">Contact</a>
                <a href="{% url 'app:faqs' %}" role="menuitem">FAQs</a>
                <a href="{% url 'app:privacy_policies' %}" role="menuitem">Privacy Policies</a>
                <a href="{% url 'app:terms_and_conditions' %}" role="menuitem">Terms & Conditions</a>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

<main class="page-transition">
  <div class="container">
    {% block content %}
    {% endblock %}
  </div>
</main>

<footer>
  <div class="container">
    &copy; {{ now.year }} Jiyash Creation — handcrafted jewelry
  </div>
</footer>

<script>
// Authentication and Cart functionality
function getAuthToken() {
  return localStorage.getItem('jwt_token');
}

function showAuthState(isAuthenticated) {
  const guestEls = document.querySelectorAll('[data-auth="guest"]');
  const authEls = document.querySelectorAll('[data-auth="auth"]');
  
  guestEls.forEach(el => el.style.display = isAuthenticated ? 'none' : '');
  authEls.forEach(el => el.style.display = isAuthenticated ? '' : 'none');
}

function updateAuthState() {
  const token = getAuthToken();
  const isAuthenticated = !!token;
  showAuthState(isAuthenticated);
  
  // Re-initialize user dropdown after auth state change
  if (isAuthenticated) {
    setTimeout(() => {
      initializeUserDropdown();
    }, 100);
  }
}

function initializeUserDropdown() {
  console.log('initializeUserDropdown called');
  const userProfileIcon = document.getElementById('userProfileIcon');
  const userDropdownMenu = document.getElementById('userDropdownMenu');
  
  console.log('Elements found:', { 
    userProfileIcon: !!userProfileIcon, 
    userDropdownMenu: !!userDropdownMenu 
  });

  if (userProfileIcon && userDropdownMenu) {
    console.log('Setting up dropdown event listeners');
    
    // Remove any existing click listeners by cloning the element
    const newIcon = userProfileIcon.cloneNode(true);
    userProfileIcon.parentNode.replaceChild(newIcon, userProfileIcon);
    
    // Add click event to toggle dropdown
    newIcon.addEventListener('click', function(e) {
      console.log('User profile icon clicked!');
      e.preventDefault();
      e.stopPropagation();
      
      const isCurrentlyActive = userDropdownMenu.classList.contains('active');
      console.log('Current dropdown state - active:', isCurrentlyActive);
      
      // Toggle the dropdown
      if (isCurrentlyActive) {
        userDropdownMenu.classList.remove('active');
        userDropdownMenu.style.display = 'none';
        newIcon.setAttribute('aria-expanded', 'false');
        console.log('Dropdown closed');
      } else {
        userDropdownMenu.classList.add('active');
        userDropdownMenu.style.display = 'block';
        newIcon.setAttribute('aria-expanded', 'true');
        console.log('Dropdown opened');
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!newIcon.contains(e.target) && !userDropdownMenu.contains(e.target)) {
        userDropdownMenu.classList.remove('active');
        userDropdownMenu.style.display = 'none';
        newIcon.setAttribute('aria-expanded', 'false');
      }
    });
    
    console.log('Dropdown initialization complete');
  } else {
    console.error('Required dropdown elements not found!');
  }
}

// Function to update cart count
function updateCartCount() {
  const token = localStorage.getItem('jwt_token');
  const cartCountEl = document.getElementById('cartCount');
  
  if (!token || !cartCountEl) {
    if (cartCountEl) cartCountEl.textContent = '0';
    return Promise.resolve();
  }

  return fetch('/api/cart/', {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      cartCountEl.textContent = data.cart_count || '0';
      cartCountEl.style.display = (data.cart_count > 0) ? 'inline' : 'none';
    }
    return data;
  })
  .catch(error => {
    console.error('Error fetching cart count:', error);
    cartCountEl.textContent = '0';
    cartCountEl.style.display = 'none';
    return { cart_count: 0 };
  });
}

// Cart navigation function with JWT authentication
function goToCart(event) {
  event.preventDefault();
  
  const token = localStorage.getItem('jwt_token');
  if (!token) {
    alert('Please login to access your cart');
    window.location.href = '/login/?next=/cart/';
    return;
  }
  
  // Set JWT token as cookie so server can access it during navigation
  document.cookie = `jwt_token=${token}; path=/; max-age=86400; SameSite=Lax`;
  window.location.href = '/cart/';
}

// Make functions globally available
window.updateCartCount = updateCartCount;
window.updateAuthState = updateAuthState;
window.goToCart = goToCart;

function handleLogout(e) {
  if (e) e.preventDefault();
  try {
    localStorage.removeItem('jwt_token');
    localStorage.removeItem('user');
    showAuthState(false);
    updateCartCount(); // Reset cart count on logout
    window.location.href = '/';
  } catch (error) {
    console.error('Logout error:', error);
    window.location.href = '/';
  }
}

// Initialize auth state and cart count on page load
document.addEventListener('DOMContentLoaded', function() {
  // Always update auth state to show/hide UI elements
  updateAuthState();
  
  // Don't automatically update cart count to avoid redirect loops
  // Cart count will be updated when user successfully logs in
  
  // Setup logout handlers
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', handleLogout);
  }
  
  const mobileLogout = document.getElementById('mobileLogout');
  if (mobileLogout) {
    mobileLogout.addEventListener('click', handleLogout);
  }
  
  // Setup user dropdown functionality immediately
  initializeUserDropdown();
});

// Mobile menu functionality
document.addEventListener('DOMContentLoaded', function() {
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const mobileNav = document.getElementById('mobileNav');
  const mobileBackBtn = document.getElementById('mobileBackBtn');
  const mobileCloseBtn = document.getElementById('mobileCloseBtn');
  const mobileNavTitle = document.getElementById('mobileNavTitle');
  const body = document.body;
  let navigationStack = [];
  
  function openMobileMenu() {
    mobileNav.classList.add('show');
    body.style.overflow = 'hidden';
    navigationStack = ['mainMenuLevel'];
    showLevel('mainMenuLevel');
    updateNavigationUI();
  }
  
  function closeMobileMenu() {
    mobileNav.classList.remove('show');
    body.style.overflow = '';
    navigationStack = [];
  }
  
  function goBack() {
    if (navigationStack.length > 1) {
      navigationStack.pop();
      const previousLevel = navigationStack[navigationStack.length - 1];
      showLevel(previousLevel);
      updateNavigationUI();
    }
  }
  
  function showLevel(levelId) {
    const levels = mobileNav.querySelectorAll('.mobile-nav-level');
    levels.forEach(level => level.style.display = 'none');
    const targetLevel = document.getElementById(levelId);
    if (targetLevel) targetLevel.style.display = 'block';
  }
  
  if (mobileMenuToggle && mobileNav) {
    mobileMenuToggle.addEventListener('click', function(e) {
      e.preventDefault();
      openMobileMenu();
    });
    mobileCloseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      closeMobileMenu();
    });
    mobileBackBtn.addEventListener('click', function(e) {
      e.preventDefault();
      goBack();
    });
    const collectionBtn = document.querySelector('.collection-btn');
    if (collectionBtn) {
      collectionBtn.addEventListener('click', function(e) {
        e.preventDefault();
      });
    }
  }

  function updateNavigationUI(title) {
    mobileNavTitle.textContent = 'Jiyash Creation';
    if (navigationStack.length > 1) mobileBackBtn.style.display = 'flex'; else mobileBackBtn.style.display = 'none';
  }
  
  function getTitleForLevel(levelId) {
    switch (levelId) {
      case 'mainMenuLevel':
        return 'Menu';
      case 'collectionLevel':
        return 'Collection';
      case 'aboutLevel':
        return 'About Us';
      default:
        const categoryBtn = document.querySelector(`[data-target="${levelId}"]`);
        return categoryBtn ? categoryBtn.getAttribute('data-category-name') : 'Category';
    }
  }
  document.addEventListener('click', function(e) {
    if (mobileNav.classList.contains('show') && !mobileNav.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
      closeMobileMenu();
    }
  });
  const finalLinks = mobileNav.querySelectorAll('a[href]');
  finalLinks.forEach(link => {
    link.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        setTimeout(() => { closeMobileMenu(); }, 100);
      }
    });
  });
  window.addEventListener('resize', function() {
    if (window.innerWidth > 768 && mobileNav.classList.contains('show')) closeMobileMenu();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && mobileNav.classList.contains('show')) {
      if (navigationStack.length > 1) goBack(); else closeMobileMenu();
    }
  });
});

// Scroll functionality
let ticking = false;
function updateHeaderOnScroll() {
  const header = document.getElementById('header-container');
  const nav = document.querySelector('nav');
  const currentScrollY = window.scrollY;
  const scrolled = currentScrollY > 30;
  if (header) header.classList.toggle('scrolled', scrolled);
  if (nav && !nav.classList.contains('show')) nav.classList.toggle('scrolled', scrolled);
  ticking = false;
}
window.addEventListener('scroll', function() {
  if (!ticking) {
    requestAnimationFrame(updateHeaderOnScroll);
    ticking = true;
  }
}, { passive: true });
</script>

<!-- Global Wishlist Functionality -->
<script src="{% static 'app/js/wishlist.js' %}"></script>

</body>
</html>
